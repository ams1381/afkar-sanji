import Head from "next/head";
import React, {useContext, useEffect, useState} from "react";
import {PageBox, QuestionerPageContainer} from "@/styles/common";
import {CommonDrawer} from "@/components/common/CommonDrawer";
import { ResultBodyContainer, ResultTableContainer} from "@/styles/Result/ResultPage";
import QuestionerHeader from "@/components/common/QuestionerHeader";
import {QuestionerResultHead} from "@/components/Questioner/Result/QuestionerResultHeader";
import {useQueries} from "@tanstack/react-query";
import {axiosInstance} from "@/utilities/axios";
import {useRouter} from "next/router";
import {QuestionerResultBody} from "@/components/Questioner/Result/QuestionerResultBody";
import {AuthContext} from "@/utilities/AuthContext";

const QuestionerResult = () => {
    const [ RightDrawerOpen , setRightDrawerOpen ] = useState(false);
    const router = useRouter();
    const [ SelectedRows , setSelectedRows ] = useState([]);
    const [ CurrentPage , SetCurrentPage ] = useState(1);
    const Auth = useContext(AuthContext);
    const [ SelectedTypeFilter , setSelectedTypeFilter ] = useState([]);
    const [ PageSize , setPageSize ] = useState(7);
    const [ QuestionnaireQuery , ResultQuery, MeQuery ] = useQueries({
        queries: [
            {
                queryKey: ['questionnaire'],
                queryFn: async () => await axiosInstance.get(`/question-api/questionnaires/${router.query.QuestionnaireUUID}/`),
                refetchOnWindowFocus : false
            },
            {
                queryKey: ['result'],
                queryFn: async () =>
                    await axiosInstance.get(`/result-api/${router.query.QuestionnaireUUID}/answer-sets/?answered_at=&end_date=&page_size=${PageSize ? PageSize : ''}&page=${CurrentPage ? CurrentPage : 1}&start_date=`) ,
                refetchOnWindowFocus : false
            },
            {
                queryKey: ['MeQuery'],
                queryFn: async () => await axiosInstance.get(`/user-api/users/me/`),
                refetchOnWindowFocus : false
            },
        ],
    });
    useEffect(() => {
        if(SelectedRows?.length == ResultQuery?.data?.data?.results?.length)
        {
            setPageSize(null)
            SetCurrentPage(null)
            setSelectedRows([])
        }
        ResultQuery.refetch()
        setSelectedRows([])
    },[CurrentPage , PageSize])
    return <>
        <Head>
            <title>Afkar Sanji | Questioner Result </title>
            <meta name="description" content="Generated by create next app" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <link rel="icon" href="/favicon.ico" />
        </Head>
        <PageBox>
            <CommonDrawer RightDrawerOpen={RightDrawerOpen} setRightDrawerOpen={setRightDrawerOpen} />
                <QuestionerHeader pageName='result' meData={MeQuery?.data?.data} />
                <main style={{ width : RightDrawerOpen ? '84%' : '100%', transition : '0.3s' }}>
                    <QuestionerPageContainer style={{ height : '100vh' , overflow : 'hidden' , maxHeight : '690px' }}>
                        <QuestionerResultHead SelectedRows={SelectedRows}
                          setSelectedRows={setSelectedRows} CurrentPage={CurrentPage}
                          SetCurrentPage={SetCurrentPage}    ResultQuery={ResultQuery}
                          SelectedTypeFilter={SelectedTypeFilter} setSelectedTypeFilter={setSelectedTypeFilter}
                          questionnaireQuery={QuestionnaireQuery}/>
                    { ResultQuery.error && ResultQuery.error.response?.status == 500 ?
                        <ResultBodyContainer error={'active'}  style={{ height : '85%'  }}>
                            <ResultTableContainer >
                                <p>مشکل سمت سرور</p>
                            </ResultTableContainer>
                        </ResultBodyContainer>
                        : <QuestionerResultBody SetCurrentPage={SetCurrentPage} ResultQuery={ResultQuery}
                               SelectedRows={SelectedRows} setSelectedRows={setSelectedRows} PageSize={PageSize}
                               SelectedTypeFilter={SelectedTypeFilter} setPageSize={setPageSize}
                               QuestionnaireQuery={QuestionnaireQuery}/>}
                </QuestionerPageContainer>
            </main>
        </PageBox>
    </>
}
export default  QuestionerResult;
export async function getServerSideProps(context) {
    const { req } = context;
    const cookies = req.headers.cookie;
    const urlDest = req.url;

    if (cookies) {
        const parsedCookies = cookies.split(';').reduce((acc, cookie) => {
            const [key, value] = cookie.trim().split('=');
            acc[key] = decodeURIComponent(value);
            return acc;
        }, {});

        return {
            props: {
                cookies: parsedCookies,
            },
        };
    }
    return {
        redirect: {
            permanent: false,
            destination: "/auth?returnUrl=" + urlDest
        }
    };
}