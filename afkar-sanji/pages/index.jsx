import { Header } from '@/components/common/Header';
import SideBar from '@/components/common/SideBar';
import { ScreenMask } from '@/styles/common';
import { CornerAddButton } from '@/styles/folders/cornerAdd';
import AddPopoverContent from '@/components/Folders/AddPopoverContent';
import { ContentBox, QuestionnaireBodyStat, QuestionnaireDiv, QuestionnaireFooter, QuestionnaireHeader, QuestionnaireNameContainer, QuestionnaireNameInput, QuestionnaireSeeResultButton } from '@/styles/folders/Questionnaire';
import QuestionnaireBox from '@/components/Folders/questionnaire';
import { Popover, Progress, message } from 'antd';
import { Icon } from '@/styles/icons';
import { Skeleton, Switch } from 'antd';
import Head from 'next/head';
import { Suspense , lazy, useRef } from 'react';
import { useEffect, useState } from 'react';
import { axiosInstance } from '@/utilities/axios';
import { useRouter } from 'next/router';
import FolderPopoverContent from '@/components/common/FolderPopover';
import { QuestionnaireContainer , MainContainer ,
   FolderEditContainer, FolderPopoverToggle 
   , EmptyFolderContainer} from '@/styles/folders/Questionnaire';
import AddQuestionnairePopUp from '@/components/Folders/AddQuestionnairePopUp';
import ProgressBarLoading from '@/styles/ProgressBarLoading';
import { useLocalStorage } from '@/utilities/useLocalStorage';
import { handleInputWidth } from '@/utilities/RenameFunctions';
import { useQuery } from '@tanstack/react-query';

export default function Home() {
  const router = useRouter();
  const { getItem , removeItem } = useLocalStorage();
  const [ MessageApi , MessageContext ] = message.useMessage();
  const [ folders , setFolder ] = useState(null);
  const [ SelectedFolder , SelectFolder ] = useState(getItem('SelectedFolder') || 0);
  const [ FolderReload , SetFolderReload ] = useState(false);
  const [ AddQuestionnaireState , setAddQuestionnaireState ] = useState(false);
  const [ SideBarOpen , setOpen ] = useState(false);
  const [ addPopOver , setAddPopover ] = useState(false);
  const [ FolderPopover , setFolderPopover ] = useState(false);
  const [ readyToCreate , setReadyToCreate ] = useState(false);
  const CornerButton = useRef(null);
  const FolderNameInput = useRef(null);
  const [ ChangeFolderName , SetChangeFolderNameState ] = useState(false);
  const [ FolderName , SetFolderName ] = useState(null);
  const { data , isLoading, error , refetch } = useQuery(['FolderFetch'],async () => await axiosInstance.get('/user-api/folders/'))
 
  useEffect(() => {
    let scroll_position = 0;
    let scroll_direction;
    window.addEventListener('scroll', function(e){
      scroll_direction = (document.body.getBoundingClientRect()).top > scroll_position ? 'up' : 'down';
      scroll_position = (document.body.getBoundingClientRect()).top;
      if(CornerButton.current)
      {
        scroll_direction == 'down' ? CornerButton.current.setAttribute('style',' right : -30%;') :
         CornerButton.current.removeAttribute('style');
      }
  });
  },[])
 
  useEffect(() => {   
    // const { getItem , setItem } = useLocalStorage();
        if(data?.data[SelectedFolder])
          SetFolderName(data?.data[SelectedFolder]?.name) 
          else {
            SelectFolder(0);
            removeItem('SelectedFolder')
          }  
  },[data])
  useEffect(() => {
    if(data?.data && data?.data[SelectedFolder])
      handleInputWidth(FolderNameInput,data?.data[SelectedFolder].name);
  },[data?.data , FolderNameInput , SelectedFolder])

  const folderNameChangeHandler = (e) => {
    handleInputWidth(FolderNameInput,FolderName);
    SetFolderName(e.target.value);
  }
  const folderRenameConfirm = async () => {
    try 
    {
      await axiosInstance.patch(`/user-api/folders/${data?.data[SelectedFolder].id}/`, { 'name' : FolderName });
      handleInputWidth(FolderNameInput,FolderName);
      // SetFolderReload(true)
      refetch();
    }
    catch(err)
    {
      MessageApi.error({
        content : Object.values(err.response.data)[0],
        duration : 5,
        style : {
          fontFamily : 'IRANSans',
          direction : 'rtl'
        }
      })
      handleInputWidth(FolderNameInput,data?.data[SelectedFolder]?.name);
    }
    SetChangeFolderNameState(false);
  }
  return (
    <>
      <Head>
        <title>Afkar Sanji</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {MessageContext}
      <ProgressBarLoading />
      <Header SetSideBar={() => setOpen(!SideBarOpen)} />
      <SideBar folders={data?.data} SelectedFolder={SelectedFolder} isopen={SideBarOpen} ReadyToCreate={readyToCreate}
       setReadyToCreate={setReadyToCreate} FolderReload={refetch}  ChangeFolder={SelectFolder}
        SetSideBar={() => setOpen(!SideBarOpen)} ChangeFolderName={SetFolderName}/>
      <Popover
            content={<AddPopoverContent SelectedFolderNumber={SelectedFolder} 
            folders={data?.data} FolderReload={refetch} 
            SetSideBar={() => setOpen(!SideBarOpen)} setReadyToCreate={setReadyToCreate}
            setAddPopover={() => setAddPopover(!addPopOver)}/>}
            trigger="click"
            open={addPopOver}
            overlayInnerStyle={{ boxShadow : 'none' , marginRight : '5.5vw' , background : 'transparent'}}
            onOpenChange={() => setAddPopover(false)}
            style={{marginRight : 15}}>
                <CornerAddButton ref={CornerButton} clicked={addPopOver ? 'true' : null} onClick={() => setAddPopover(!addPopOver)}>
                  <Icon name='Add' />
                </CornerAddButton>
        </Popover>
    <ContentBox >
      { 
        data?.data && data?.data.length !== 0 ? <MainContainer>
        <FolderEditContainer>
            <Popover
            trigger="click"
            content={<FolderPopoverContent RenameFolderState={SetChangeFolderNameState} RenameInput={FolderNameInput}
            SelectFolder={SelectFolder} FolderReload={refetch} 
            closeEditPopover={() => setFolderPopover(false)}
             SelectedFolderNumber={SelectedFolder} Folders={data?.data} />}
            open={FolderPopover}
            placement="bottom"
            overlayInnerStyle={{ marginRight : 15}}
            onOpenChange={() => setFolderPopover(false)} />
            <FolderPopoverToggle onClick={ChangeFolderName ? folderRenameConfirm : () => setFolderPopover(!FolderPopover)}
                  style={FolderName ? { pointerEvents : 'all'} : { pointerEvents : 'none'}}>
                    {ChangeFolderName ? <Icon name='GrayCheck' style={{ width : 20 }} /> : <Icon name='Menu' /> }
                  </FolderPopoverToggle>
              {ChangeFolderName && <FolderPopoverToggle onClick={() => {
                  SetFolderName(data?.data[SelectedFolder]?.name)
                  handleInputWidth(FolderNameInput,data?.data[SelectedFolder]?.name)
                  SetChangeFolderNameState(false);
              }}>
                <Icon name='BlackClose' style={{ width : 15 , marginLeft : 10}} />
              </FolderPopoverToggle>}
              <QuestionnaireNameInput type='text' onKeyDown={e => e.key == 'Enter' ? folderRenameConfirm() : ''}
              ref={FolderNameInput} value={FolderName} onChange={folderNameChangeHandler}
               disabled={!ChangeFolderName} /> 
          </FolderEditContainer>
      <QuestionnaireContainer>        
        {
          data?.data[SelectedFolder].questionnaires.length ? data?.data[SelectedFolder].questionnaires.map((item) => 
          <QuestionnaireBox FolderReload={refetch}  Questionnaire={item} key={item.id} />)
          : <EmptyFolderContainer>
          <p>یک پرسشنامه درست کنید</p>
          <AddQuestionnairePopUp AddQuestionnaireModal={AddQuestionnaireState}
          setQuestionnaireModalState={() => setAddQuestionnaireState(!AddQuestionnaireState)}
          FolderReload={refetch} 
          folders={data?.data}
          SelectedFolderNumber={SelectedFolder}
          />
          <button onClick={() => setAddQuestionnaireState(true)}>
              <p>ایجاد نظر سنجی</p>
              <Icon name='Folder' style={{ width : 14 }} />
             </button>
          </EmptyFolderContainer> 
        }
      </QuestionnaireContainer>
        </MainContainer> 
        : data?.data ?  <EmptyFolderContainer>
            <p>برای مدیریت بهتر نظر سنجی ها یک پوشه درست کن</p>
            <button onClick={() => setOpen(true)}>
                <p>پوشه ها</p>
                <Icon name='Folder' />
               </button>
         </EmptyFolderContainer> : <MainContainer>
          <FolderEditContainer>
            <Skeleton.Input active style={{ height : 20 }}/>
          </FolderEditContainer>
         <QuestionnaireContainer>
          <QuestionnaireDiv isloading={true}>
              <QuestionnaireHeader>
                  <QuestionnaireNameContainer>
                      <Skeleton.Input active  style={{ height : 20 }}/>
                  </QuestionnaireNameContainer>
                  <div className='questionnaire_preview'>
                    <Skeleton.Input active style={{ minWidth : 20 , width : 90 , height : 20 }}/>
                  </div>
              </QuestionnaireHeader>
              <div className="questionnaire_body">
                  <div className="questionnaire_stats">
                          <QuestionnaireBodyStat>
                              <Skeleton.Input active style={{ height : 20 , width: 80 , minWidth : 20}} />
                              <Skeleton.Input active style={{ height : 20 , width: 90 , minWidth : 20}}/>
                          </QuestionnaireBodyStat>
                          <QuestionnaireBodyStat>
                              <Skeleton.Input active  style={{ height : 20 , width: 70 , minWidth : 20}}/>
                              <Skeleton.Input active  style={{ height : 20 , width: 110 , minWidth : 20}}/>
                          </QuestionnaireBodyStat>
                    </div>
                    <div className="questionnaire_see_result">
                      <QuestionnaireSeeResultButton>
                          <Skeleton.Button active />
                      </QuestionnaireSeeResultButton>
                      
                    </div>
              </div>
              <QuestionnaireFooter loading='active'>
                  <Skeleton.Button active style={{ width : 73 }} />
                  <Skeleton.Button active style={{ width : 73 }}/>
                  <Skeleton.Button active style={{ width : 73 }}/>
                  <Skeleton.Button active style={{ width : 73 }}/>
              </QuestionnaireFooter>
          </QuestionnaireDiv>
          <QuestionnaireDiv isloading={true}>
              <QuestionnaireHeader>
                  <QuestionnaireNameContainer>
                      <Skeleton.Input active  style={{ height : 20 }}/>
                  </QuestionnaireNameContainer>
                  <div className='questionnaire_preview'>
                    <Skeleton.Input active style={{ minWidth : 20 , width : 90 , height : 20 }}/>
                  </div>
              </QuestionnaireHeader>
              <div className="questionnaire_body">
                  <div className="questionnaire_stats">
                          <QuestionnaireBodyStat>
                              <Skeleton.Input active style={{ height : 20 , width: 80 , minWidth : 20}} />
                              <Skeleton.Input active style={{ height : 20 , width: 90 , minWidth : 20}}/>
                          </QuestionnaireBodyStat>
                          <QuestionnaireBodyStat>
                              <Skeleton.Input active  style={{ height : 20 , width: 70 , minWidth : 20}}/>
                              <Skeleton.Input active  style={{ height : 20 , width: 110 , minWidth : 20}}/>
                          </QuestionnaireBodyStat>
                    </div>
                    <div className="questionnaire_see_result">
                      <QuestionnaireSeeResultButton>
                          <Skeleton.Button active />
                      </QuestionnaireSeeResultButton>
                      
                    </div>
              </div>
              <QuestionnaireFooter loading='active'>
                  <Skeleton.Button active style={{ width : 73 }} />
                  <Skeleton.Button active style={{ width : 73 }}/>
                  <Skeleton.Button active style={{ width : 73 }}/>
                  <Skeleton.Button active style={{ width : 73 }}/>
              </QuestionnaireFooter>
          </QuestionnaireDiv>
          <QuestionnaireDiv isloading={true}>
              <QuestionnaireHeader>
                  <QuestionnaireNameContainer>
                      <Skeleton.Input active  style={{ height : 20 }}/>
                  </QuestionnaireNameContainer>
                  <div className='questionnaire_preview'>
                    <Skeleton.Input active style={{ minWidth : 20 , width : 90 , height : 20 }}/>
                  </div>
              </QuestionnaireHeader>
              <div className="questionnaire_body">
                  <div className="questionnaire_stats">
                          <QuestionnaireBodyStat>
                              <Skeleton.Input active style={{ height : 20 , width: 80 , minWidth : 20}} />
                              <Skeleton.Input active style={{ height : 20 , width: 90 , minWidth : 20}}/>
                          </QuestionnaireBodyStat>
                          <QuestionnaireBodyStat>
                              <Skeleton.Input active  style={{ height : 20 , width: 70 , minWidth : 20}}/>
                              <Skeleton.Input active  style={{ height : 20 , width: 110 , minWidth : 20}}/>
                          </QuestionnaireBodyStat>
                    </div>
                    <div className="questionnaire_see_result">
                      <QuestionnaireSeeResultButton>
                          <Skeleton.Button active />
                      </QuestionnaireSeeResultButton>
                      
                    </div>
              </div>
              <QuestionnaireFooter loading='active'>
                  <Skeleton.Button active style={{ width : 73 }} />
                  <Skeleton.Button active style={{ width : 73 }}/>
                  <Skeleton.Button active style={{ width : 73 }}/>
                  <Skeleton.Button active style={{ width : 73 }}/>
              </QuestionnaireFooter>
          </QuestionnaireDiv>
         </QuestionnaireContainer>
        </MainContainer> 
      } 
    </ContentBox>
    </>
  )
}